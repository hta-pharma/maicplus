<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="maicplus">
<title>Using maicplus • maicplus</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using maicplus">
<meta property="og:description" content="maicplus">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-125641273-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-125641273-1');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">maicplus</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/using_maicplus.html">Using maicplus</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<!-- start dropdown for versions --> <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle"
          data-bs-toggle="dropdown" role="button"
          aria-expanded="false" aria-haspopup="true"
          id="dropdown-versions">Versions</a> <div class="dropdown-menu" aria-labelledby="dropdown-versions"> <a class="dropdown-item" data-toggle="tooltip" title="" href="https://hta-pharma.github.io/maicplus/main">main</a> </div></li>
<!-- end dropdown for versions -->
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/hta-pharma/maicplus">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using maicplus</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/hta-pharma/maicplus/blob/HEAD/vignettes/using_maicplus.Rmd" class="external-link"><code>vignettes/using_maicplus.Rmd</code></a></small>
      <div class="d-none name"><code>using_maicplus.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This package describes the steps required to perform a
matching-adjusted indirect comparison (MAIC) analysis using the
<code>maicplus</code> package in R where the endpoint of interest is
either time-to-event (e.g. overall survival) or binary (e.g. objective
tumor response).</p>
<p>The methods described in this document are based on those originally
described by Signorovitch et al. 2010 and described in the National
Institute for Health and Care Excellence (NICE) Decision Support Unit
(DSU) Technical Support Document (TSD) 18. [signorovitch2010;
phillippo2016a]</p>
<p>MAIC methods are often required when:</p>
<ul>
<li>There is no common comparator treatment to link a clinical trial of
a new intervention to clinical trials of other treatments in a given
disease area. For example if the only study of a new intervention is a
single arm trial with no control group. This is commonly referred to as
an unanchored MAIC.</li>
<li>A common comparator is available to link a clinical trial of a new
intervention to a clinical trial of one other treatment in a given
disease area but there are substantial differences in patient
demographic or disease characteristics that are believed to be treatment
effect modifiers. This is commonly referred to as an anchored MAIC.</li>
</ul>
<p>The premise of MAIC methods is to adjust for between-trial
differences in patient demographic or disease characteristics at
baseline. When a common treatment comparator or ‘linked network’ are
unavailable, a MAIC assumes that differences between absolute outcomes
that would be observed in each trial are entirely explained by
imbalances in prognostic variables and treatment effect modifiers.
Prognostic variables are those that are predictive of disease outcomes,
independent of the treatment received. For example, older patients may
have increased risk of death compared to younger patients. Treatment
effect modifiers are those variables that influence the relative effect
of one treatment compared to another. For example patients with a better
performance status may experience a larger treatment benefit than those
with a worse performance status. Under this assumption, every prognostic
variable and every treatment effect modifier that is imbalanced between
the two studies must be available. This assumption is generally
considered very difficult to meet. [phillippo2016a] There are several
ways of identifying prognostic variables/treatment effect modifiers to
be used in the MAIC analyses, some of which include:</p>
<ul>
<li>Clinical expertise (when available to a project)</li>
<li>Published papers/previous submissions (what has been identified in
the disease area previously)</li>
<li>Univariable/multivariable regression analyses to identify which
covariates have a significant effect on the outcome</li>
<li>Subgroup analyses of clinical trials may identify interactions
between patient characteristics and the relative treatment effect</li>
</ul>
</div>
<div class="section level2">
<h2 id="theory-behind-maic">Theory behind MAIC<a class="anchor" aria-label="anchor" href="#theory-behind-maic"></a>
</h2>
<p>We will briefly go over the theory behind MAIC. For detailed
information, see Signorovitch et al. 2010.</p>
<p>Let us define <span class="math inline">\(t_i\)</span> to be the
treatment patient <span class="math inline">\(i\)</span> received. We
assume <span class="math inline">\(t_i=0\)</span> if the patient
received intervention (IPD) and <span class="math inline">\(t_i=1\)</span> if the patient received comparator
treatment. The causal effect of treatment <span class="math inline">\(T=0\)</span> vs <span class="math inline">\(T=1\)</span> on the mean of the outcome <span class="math inline">\(Y\)</span> can be estimated as below</p>
<p><span class="math display">\[
\frac{\sum_{i=1}^{n}y_{i}(1-t_{i})w_{i}}{\sum_{i=1}^{n}(1-t_{i})w_{i}}-\bar{y}_{1}
\]</span></p>
<p>where <span class="math inline">\(w_i=\frac{Pr(T_i=1\mid
x_i)}{Pr(T_i=0\mid x_i)}\)</span> is the odds that patient <span class="math inline">\(i\)</span> received treatment <span class="math inline">\(T=1\)</span> vs <span class="math inline">\(T=0\)</span> (i.e. enrolls in aggregate data study
vs IPD study) given baseline characteristics <span class="math inline">\(x_i\)</span>. Thus, the patients receiving <span class="math inline">\(T=0\)</span> are re-weighted to match the
distribution of patients receiving <span class="math inline">\(T=1\)</span>. Note that this causal effect would
be the case when the outcome <span class="math inline">\(Y\)</span> is
continuous. If the outcome is binary, <span class="math inline">\(Y\)</span> would be a proportion and we would use
a link function such as logit to give us the causal effect in an odds
ratio scale. As in propensity score methods, we may assume <span class="math inline">\(w_i\)</span> to follow logistic regression
form</p>
<p><span class="math display">\[
w_{i}=exp(x_i^{T}\beta)
\]</span></p>
<p>However, in order to estimate <span class="math inline">\(\beta\)</span>, we cannot use maximum likelihood
approach because we do not have IPD for both trials. Instead, we use
method of moments. We estimate <span class="math inline">\(\beta\)</span> such that the weighted averages of
the covariates in the IPD exactly matches the aggregate data averages.
Mathematically speaking, we want to estimate <span class="math inline">\(\beta\)</span> such that:</p>
<p><span class="math display">\[
0=\frac{\sum_{i=1}^{n}x_{i}exp(x_i^{T}\hat{\beta})}{\sum_{i=1}^{n}exp(x_i^{T}\hat{\beta})}-\bar{x}_{agg}
\]</span></p>
<p>If the <span class="math inline">\(x_i\)</span> contains all
confounders and the logistic regression for <span class="math inline">\(w_i\)</span> is correctly specified, we obtain a
consistent estimate of the causal effect of intervention vs comparator
treatment. Above equation is equivalent to</p>
<p><span class="math display">\[
0=\sum_{i=1}^{n}(x_{i}-\bar{x}_{agg})exp(x_{i}^{T}\hat{\beta})
\]</span></p>
<p>We could transform transform IPD by subtracting the aggregate data
means (this is why centering is needed when preprocessing).</p>
<p><span class="math display">\[
0=\sum_{i=1}^{n}x_{i}exp(x_{i}^{T}\hat{\beta})
\]</span></p>
<p>Note that this is the first derivative of</p>
<p><span class="math display">\[
Q(\beta)=\sum_{i=1}^{n}exp(x_{i}^{T}\hat{\beta})
\]</span></p>
<p>which has second derivative</p>
<p><span class="math display">\[
Q''(\beta)=\sum_{i=1}^{n}x_ix_i^Texp(x_{i}^{T}\hat{\beta})
\]</span></p>
<p>Since <span class="math inline">\(Q''(\beta)\)</span> is
positive-definite for all <span class="math inline">\(\beta\)</span>,
<span class="math inline">\(Q(\beta)\)</span> is convex and any finite
solution from the equation is unique and corresponds to the global
minimum of <span class="math inline">\(Q(\beta)\)</span>. Thus, we can
use optimization methods to calculate <span class="math inline">\(\beta\)</span>.</p>
</div>
<div class="section level2">
<h2 id="example-scenario">Example scenario<a class="anchor" aria-label="anchor" href="#example-scenario"></a>
</h2>
<p>We present an unanchored MAIC of two treatments in lung cancer. The
two endpoints being compared are overall survival (a time to event
outcome) and objective response (a binary outcome). The data available
are:</p>
<ul>
<li>Individual patient data from a single arm study</li>
<li>Aggregate summary data for the comparator study</li>
<li>Pseudo patient data from the comparator study. This is not required
for the matching process but is needed to derive the relative treatment
effects between the internal treatment and comparator treatment.</li>
</ul>
</div>
<div class="section level2">
<h2 id="preprocessing">Preprocessing<a class="anchor" aria-label="anchor" href="#preprocessing"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hta-pharma/maicplus/" class="external-link">maicplus</a></span><span class="op">)</span></span></code></pre></div>
<p>Additional suggested packages for this vignette:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span> <span class="co"># this is used for data merging/cleaning. Package itself does not depend on dplyr</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># library(clubSandwich) # For robust standard error in logistic regression</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sandwich.R-Forge.R-project.org/" class="external-link">sandwich</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/survminer/index.html" class="external-link">survminer</a></span><span class="op">)</span> <span class="co"># for ggsurvplot</span></span>
<span><span class="co">#&gt; Loading required package: ggplot2</span></span>
<span><span class="co">#&gt; Loading required package: ggpubr</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'survminer'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:survival':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     myeloma</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span> <span class="co"># for ggplot functions</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">boot</span><span class="op">)</span> <span class="co"># for bootstrapping</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'boot'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:survival':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     aml</span></span></code></pre></div>
<div class="section level3">
<h3 id="preprocessing-ipd">Preprocessing IPD<a class="anchor" aria-label="anchor" href="#preprocessing-ipd"></a>
</h3>
<p>In this example scenario, age, sex, the Eastern Cooperative Oncology
Group (ECOG) performance status, smoking status, and number of previous
treatments have been identified as imbalanced prognostic
variables/treatment effect modifiers.</p>
<p>This example reads in and combines data from three standard simulated
data sets (adsl, adrs and adtte) which are saved as ‘.csv’ files.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"adsl.csv"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"maicplus"</span>,</span>
<span>  mustWork <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">adrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"adrs.csv"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"maicplus"</span>,</span>
<span>  mustWork <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">adtte</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"adtte.csv"</span>, package <span class="op">=</span> <span class="st">"maicplus"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Data containing the matching variables</span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="va">adsl</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>SEX_MALE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">SEX</span> <span class="op">==</span> <span class="st">"Male"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>AGE_SQUARED <span class="op">=</span> <span class="va">AGE</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Could use built-in function for dummizing variables</span></span>
<span><span class="co"># adsl &lt;- dummize_ipd(adsl, dummize_cols=c("SEX"), dummize_ref_level=c("Female"))</span></span>
<span></span>
<span><span class="co"># Response data</span></span>
<span><span class="va">adrs</span> <span class="op">&lt;-</span> <span class="va">adrs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">PARAM</span> <span class="op">==</span> <span class="st">"Response"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">ARM</span>, RESPONSE <span class="op">=</span> <span class="va">AVAL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Time to event data (overall survival)</span></span>
<span><span class="va">adtte</span> <span class="op">&lt;-</span> <span class="va">adtte</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">PARAMCD</span> <span class="op">==</span> <span class="st">"OS"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>EVENT <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">CNSR</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">ARM</span>, TIME <span class="op">=</span> <span class="va">AVAL</span>, <span class="va">EVENT</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine all ipd data</span></span>
<span><span class="va">ipd</span> <span class="op">&lt;-</span> <span class="va">adsl</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="va">adrs</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"USUBJID"</span>, <span class="st">"ARM"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="va">adtte</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"USUBJID"</span>, <span class="st">"ARM"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ipd</span><span class="op">)</span></span>
<span><span class="co">#&gt;   X USUBJID ARM AGE    SEX SMOKE ECOG0 N_PR_THER SEX_MALE AGE_SQUARED RESPONSE</span></span>
<span><span class="co">#&gt; 1 1       1   A  45   Male     0     0         4        1        2025        0</span></span>
<span><span class="co">#&gt; 2 2       2   A  71   Male     0     0         3        1        5041        1</span></span>
<span><span class="co">#&gt; 3 3       3   A  58   Male     1     1         2        1        3364        1</span></span>
<span><span class="co">#&gt; 4 4       4   A  48 Female     0     1         4        0        2304        1</span></span>
<span><span class="co">#&gt; 5 5       5   A  69   Male     0     1         4        1        4761        0</span></span>
<span><span class="co">#&gt; 6 6       6   A  48 Female     0     1         4        0        2304        0</span></span>
<span><span class="co">#&gt;       TIME EVENT</span></span>
<span><span class="co">#&gt; 1 281.5195     0</span></span>
<span><span class="co">#&gt; 2 500.0000     0</span></span>
<span><span class="co">#&gt; 3 304.6406     0</span></span>
<span><span class="co">#&gt; 4 102.4731     0</span></span>
<span><span class="co">#&gt; 5 101.6632     0</span></span>
<span><span class="co">#&gt; 6 237.0593     1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="preprocessing-aggregate-data">Preprocessing aggregate data<a class="anchor" aria-label="anchor" href="#preprocessing-aggregate-data"></a>
</h3>
<p>There are two ways of specifying aggregate data. One approach is to
read in aggregate data using an excel spreadsheet. In the spreadsheet,
possible variable types include mean, median, or standard deviation for
continuous variables and count or proportion for binary variables. The
naming should be followed by these suffixes accordingly: _COUNT, _MEAN,
_MEDIAN, _SD, _PROP. Then, <code>process_agd</code> will convert the
count into proportions.</p>
<p>Other way is to define data frame of aggregate data in R. If you do
it this way, _COUNT prefix should not be specified and only proportion
is allowed for binary variables. Other suffix names would be the same as
the first approach.</p>
<p>Possible missingness in the binary variables should be accounted for
by subtracting the denominator by the missing count i.e. proportion =
count / (N - missing).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Through excel spreadsheet</span></span>
<span><span class="co"># target_pop &lt;- read.csv(system.file("extdata","aggregate_data_example_1.csv", package = "maicplus", mustWork = TRUE))</span></span>
<span><span class="co"># agd &lt;- process_agd(target_pop)</span></span>
<span></span>
<span><span class="co"># Second approach by defining a data frame in R</span></span>
<span><span class="va">agd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  STUDY <span class="op">=</span> <span class="st">"Lung study"</span>,</span>
<span>  ARM <span class="op">=</span> <span class="st">"Total"</span>,</span>
<span>  N <span class="op">=</span> <span class="fl">300</span>,</span>
<span>  AGE_MEAN <span class="op">=</span> <span class="fl">51</span>,</span>
<span>  AGE_MEDIAN <span class="op">=</span> <span class="fl">49</span>,</span>
<span>  AGE_SD <span class="op">=</span> <span class="fl">3.25</span>,</span>
<span>  SEX_MALE_PROP <span class="op">=</span> <span class="fl">147</span> <span class="op">/</span> <span class="fl">300</span>,</span>
<span>  ECOG0_PROP <span class="op">=</span> <span class="fl">0.40</span>,</span>
<span>  SMOKE_PROP <span class="op">=</span> <span class="fl">58</span> <span class="op">/</span> <span class="op">(</span><span class="fl">300</span> <span class="op">-</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>  N_PR_THER_MEDIAN <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="preprocessing-aggregate-data-1">Preprocessing aggregate data<a class="anchor" aria-label="anchor" href="#preprocessing-aggregate-data-1"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#### prepare data</span></span>
<span><span class="va">ipd_centered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/center_ipd.html">center_ipd</a></span><span class="op">(</span>ipd <span class="op">=</span> <span class="va">ipd</span>, agd <span class="op">=</span> <span class="va">agd</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ipd_centered</span><span class="op">)</span></span>
<span><span class="co">#&gt;   X USUBJID ARM AGE    SEX SMOKE ECOG0 N_PR_THER SEX_MALE AGE_SQUARED RESPONSE</span></span>
<span><span class="co">#&gt; 1 1       1   A  45   Male     0     0         4        1        2025        0</span></span>
<span><span class="co">#&gt; 2 2       2   A  71   Male     0     0         3        1        5041        1</span></span>
<span><span class="co">#&gt; 3 3       3   A  58   Male     1     1         2        1        3364        1</span></span>
<span><span class="co">#&gt; 4 4       4   A  48 Female     0     1         4        0        2304        1</span></span>
<span><span class="co">#&gt; 5 5       5   A  69   Male     0     1         4        1        4761        0</span></span>
<span><span class="co">#&gt; 6 6       6   A  48 Female     0     1         4        0        2304        0</span></span>
<span><span class="co">#&gt;       TIME EVENT AGE_CENTERED AGE_MEDIAN_CENTERED AGE_SQUARED_CENTERED</span></span>
<span><span class="co">#&gt; 1 281.5195     0           -6                -0.5            -586.5625</span></span>
<span><span class="co">#&gt; 2 500.0000     0           20                 0.5            2429.4375</span></span>
<span><span class="co">#&gt; 3 304.6406     0            7                 0.5             752.4375</span></span>
<span><span class="co">#&gt; 4 102.4731     0           -3                -0.5            -307.5625</span></span>
<span><span class="co">#&gt; 5 101.6632     0           18                 0.5            2149.4375</span></span>
<span><span class="co">#&gt; 6 237.0593     1           -3                -0.5            -307.5625</span></span>
<span><span class="co">#&gt;   SEX_MALE_CENTERED ECOG0_CENTERED SMOKE_CENTERED N_PR_THER_MEDIAN_CENTERED</span></span>
<span><span class="co">#&gt; 1              0.51           -0.4     -0.1966102                       0.5</span></span>
<span><span class="co">#&gt; 2              0.51           -0.4     -0.1966102                       0.5</span></span>
<span><span class="co">#&gt; 3              0.51            0.6      0.8033898                      -0.5</span></span>
<span><span class="co">#&gt; 4             -0.49            0.6     -0.1966102                       0.5</span></span>
<span><span class="co">#&gt; 5              0.51            0.6     -0.1966102                       0.5</span></span>
<span><span class="co">#&gt; 6             -0.49            0.6     -0.1966102                       0.5</span></span></code></pre></div>
<div class="section level4">
<h4 id="how-to-handle-standard-deviation-aggregate-summary">How to handle standard deviation aggregate summary<a class="anchor" aria-label="anchor" href="#how-to-handle-standard-deviation-aggregate-summary"></a>
</h4>
<p>As described by Phillippo et al. 2016, balancing on both mean and
standard deviation for continuous variables (where possible) may be
considered in some cases. If a standard deviation is provided in the
comparator population, preprocessing is done so that in the target
population, <span class="math inline">\(E(X^2)\)</span> is calculated
using the variance formula <span class="math inline">\(Var(X)=E(X^{2})-E(X)^{2}\)</span>. This <span class="math inline">\(E(X^2)\)</span> in the target population is
matched with the IPD level data, which is why <span class="math inline">\(X^{2}\)</span> was calculated during the
preprocessing stage of IPD.</p>
</div>
<div class="section level4">
<h4 id="how-to-handle-median-aggregate-summary">How to handle median aggregate summary<a class="anchor" aria-label="anchor" href="#how-to-handle-median-aggregate-summary"></a>
</h4>
<p>If a median is provided, IPD is preprocessed to categorize the
variable into a binary variable. All the values in the IPD that are
higher than the comparator population median is assigned a value of 1.
Conversely, all values that are lower are assigned a value of 0.
Comparator population median is replaced by 0.5 to adjust to the
categorization in the IPD data. The newly created IPD binary variable is
matched so that the proportion is 0.5.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="calculating-weights">Calculating weights<a class="anchor" aria-label="anchor" href="#calculating-weights"></a>
</h2>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># list variables that are going to be used to match</span></span>
<span><span class="va">centered_colnames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AGE"</span>, <span class="st">"AGE_SQUARED"</span>, <span class="st">"SEX_MALE"</span>, <span class="st">"ECOG0"</span>, <span class="st">"SMOKE"</span>, <span class="st">"N_PR_THER_MEDIAN"</span><span class="op">)</span></span>
<span><span class="va">centered_colnames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">centered_colnames</span>, <span class="st">"_CENTERED"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">weighted_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_weights.html">estimate_weights</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">ipd_centered</span>,</span>
<span>  centered_colnames <span class="op">=</span> <span class="va">centered_colnames</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Alternatively, you can specify the numeric column locations for centered_colnames</span></span>
<span><span class="co"># weighted_data &lt;- estimate_weights(ipd_centered, centered_colnames = c(14, 16:20))</span></span>
<span></span>
<span><span class="co"># Two options to plot weights plot using base R or ggplot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">weighted_data</span><span class="op">)</span></span></code></pre></div>
<p><img src="using_maicplus_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">weighted_data</span>, ggplot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="using_maicplus_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<p>Another check after the weights are calculated is to look at how the
weighted covariates match with the aggregate data summary.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check_weights.html">check_weights</a></span><span class="op">(</span><span class="va">weighted_data</span>, <span class="va">agd</span><span class="op">)</span></span>
<span><span class="va">outdata</span></span>
<span><span class="co">#&gt;   covariate match_stat internal_trial internal_trial_after_weighted</span></span>
<span><span class="co">#&gt; 1       AGE       Mean         59.850                         51.00</span></span>
<span><span class="co">#&gt; 2       AGE         SD          9.011                          3.25</span></span>
<span><span class="co">#&gt; 3  SEX_MALE       Prop          0.380                          0.49</span></span>
<span><span class="co">#&gt; 4     ECOG0       Prop          0.410                          0.40</span></span>
<span><span class="co">#&gt; 5     SMOKE       Prop          0.320                          0.20</span></span>
<span><span class="co">#&gt; 6 N_PR_THER     Median          3.000                          2.00</span></span>
<span><span class="co">#&gt;   external_trial sum_centered_IPD_with_weights</span></span>
<span><span class="co">#&gt; 1          51.00                        0.0001</span></span>
<span><span class="co">#&gt; 2           3.25                        0.0125</span></span>
<span><span class="co">#&gt; 3           0.49                        0.0000</span></span>
<span><span class="co">#&gt; 4           0.40                        0.0000</span></span>
<span><span class="co">#&gt; 5           0.20                        0.0000</span></span>
<span><span class="co">#&gt; 6           2.00                        0.0000</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="time-to-event-analysis">Time to event analysis<a class="anchor" aria-label="anchor" href="#time-to-event-analysis"></a>
</h2>
<p>We first need to combine internal IPD data with pseudo comparator
IPD. To obtain pseudo comparator IPD, we would digitize Kaplan Meier
curves from the comparator study.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pseudo_ipd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"psuedo_IPD.csv"</span>, package <span class="op">=</span> <span class="st">"maicplus"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ipd_matched</span> <span class="op">&lt;-</span> <span class="va">weighted_data</span><span class="op">$</span><span class="va">data</span></span>
<span></span>
<span><span class="co"># Need to specify pseudo_ipd ARM if not specified</span></span>
<span><span class="va">pseudo_ipd</span><span class="op">$</span><span class="va">ARM</span> <span class="op">&lt;-</span> <span class="st">"B"</span> <span class="co"># Need to specify ARM for pseudo ipd</span></span>
<span></span>
<span><span class="co"># Need to specify weights for pseudo_ipd which is 1</span></span>
<span><span class="va">pseudo_ipd</span><span class="op">$</span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># make sure pseudo_ipd name has same name compared with ipd_matched for time, event, arm</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pseudo_ipd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TIME"</span>, <span class="st">"EVENT"</span>, <span class="st">"ARM"</span>, <span class="st">"weights"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined_data_tte</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="va">ipd_matched</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pseudo_ipd</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  <span class="va">pseudo_ipd</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">combined_data_tte</span><span class="op">)</span></span>
<span><span class="co">#&gt;       TIME EVENT ARM      weights</span></span>
<span><span class="co">#&gt; 1 281.5195     0   A 6.884028e-01</span></span>
<span><span class="co">#&gt; 2 500.0000     0   A 5.669105e-08</span></span>
<span><span class="co">#&gt; 3 304.6406     0   A 1.146355e-01</span></span>
<span><span class="co">#&gt; 4 102.4731     0   A 1.178307e+00</span></span>
<span><span class="co">#&gt; 5 101.6632     0   A 1.605203e-06</span></span>
<span><span class="co">#&gt; 6 237.0593     1   A 1.178307e+00</span></span></code></pre></div>
<div class="section level3">
<h3 id="report-1-kaplan-meier-plot">Report 1: Kaplan-Meier plot<a class="anchor" aria-label="anchor" href="#report-1-kaplan-meier-plot"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kmobj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">TIME</span>, <span class="va">EVENT</span><span class="op">)</span> <span class="op">~</span> <span class="va">ARM</span>, <span class="va">combined_data_tte</span>, conf.type <span class="op">=</span> <span class="st">"log-log"</span><span class="op">)</span></span>
<span><span class="va">kmobj_adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">TIME</span>, <span class="va">EVENT</span><span class="op">)</span> <span class="op">~</span> <span class="va">ARM</span>,</span>
<span>  <span class="va">combined_data_tte</span>,</span>
<span>  weights <span class="op">=</span> <span class="va">combined_data_tte</span><span class="op">$</span><span class="va">weights</span>, conf.type <span class="op">=</span> <span class="st">"log-log"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>cex.main <span class="op">=</span> <span class="fl">0.85</span><span class="op">)</span></span>
<span></span>
<span><span class="va">kmdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="../reference/survfit_makeup.html">survfit_makeup</a></span><span class="op">(</span><span class="va">kmobj</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">kmdat</span><span class="op">$</span><span class="va">treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">kmdat</span><span class="op">$</span><span class="va">treatment</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/basic_kmplot.html">basic_kmplot</a></span><span class="op">(</span><span class="va">kmdat</span>,</span>
<span>  time_scale <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>  time_grid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span>, by <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  show_risk_set <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  main_title <span class="op">=</span> <span class="st">"Kaplan-Meier Curves"</span>,</span>
<span>  subplot_heights <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  suppress_plot_layout <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  use_colors <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  use_line_types <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="using_maicplus_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>There is also a <code>"ggplot"</code> option for Kaplan-Meier curves
using <code>survminer</code> R package.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># km_plot2(combined_data_tte, trt = "A", trt_ext = "B", censor = TRUE, risk.table = TRUE)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="report-2-analysis-table-cox-model-before-and-after-matching-incl-median-survival-time">Report 2: Analysis table (Cox model) before and after matching, incl
Median Survival Time<a class="anchor" aria-label="anchor" href="#report-2-analysis-table-cox-model-before-and-after-matching-incl-median-survival-time"></a>
</h3>
<p>We can then fit a cox regression model using the combined dataset.
For the weight adjusted cox regression, we fit the model with robust
standard errors. Along with the hazard ratios, we can also find median
survival time using <code>medSurv_makeup</code> function. Then,
<code>report_table_tte</code> function nicely combines the information
together and create a result table.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit a Cox model with/without weights to estimate the HR</span></span>
<span><span class="va">unweighted_cox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">TIME</span>, <span class="va">EVENT</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">~</span> <span class="va">ARM</span>, data <span class="op">=</span> <span class="va">combined_data_tte</span><span class="op">)</span></span>
<span><span class="va">weighted_cox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">TIME</span>, <span class="va">EVENT</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">~</span> <span class="va">ARM</span>,</span>
<span>  data <span class="op">=</span> <span class="va">combined_data_tte</span>, weights <span class="op">=</span> <span class="va">combined_data_tte</span><span class="op">$</span><span class="va">weights</span>, robust <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Derive median survival time</span></span>
<span><span class="va">medSurv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/medSurv_makeup.html">medSurv_makeup</a></span><span class="op">(</span><span class="va">kmobj</span>, legend <span class="op">=</span> <span class="st">"before matching"</span>, time_scale <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span></span>
<span><span class="va">medSurv_adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/medSurv_makeup.html">medSurv_makeup</a></span><span class="op">(</span><span class="va">kmobj_adj</span>, legend <span class="op">=</span> <span class="st">"after matching"</span>, time_scale <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span></span>
<span><span class="va">medSurv_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">medSurv</span>, <span class="va">medSurv_adj</span><span class="op">)</span></span>
<span><span class="va">medSurv_out</span></span>
<span><span class="co">#&gt;   treatment            type records    n.max  n.start    events    rmean</span></span>
<span><span class="co">#&gt; 1     ARM=A before matching     500 500.0000 500.0000 190.00000 265.1012</span></span>
<span><span class="co">#&gt; 2     ARM=B before matching     300 300.0000 300.0000 178.00000 130.9893</span></span>
<span><span class="co">#&gt; 3     ARM=A  after matching     500 199.8422 199.8422  66.84953 307.7223</span></span>
<span><span class="co">#&gt; 4     ARM=B  after matching     300 300.0000 300.0000 178.00000 130.9893</span></span>
<span><span class="co">#&gt;   se(rmean)    median   0.95LCL  0.95UCL</span></span>
<span><span class="co">#&gt; 1  10.80981 230.94839 191.10767 313.1574</span></span>
<span><span class="co">#&gt; 2  10.24910  83.58535  68.82298 101.0786</span></span>
<span><span class="co">#&gt; 3  16.71338 362.20670 237.05932 452.7209</span></span>
<span><span class="co">#&gt; 4  10.24910  83.58535  68.82298 101.0786</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/report_table_tte.html">report_table_tte</a></span><span class="op">(</span><span class="va">unweighted_cox</span>, <span class="va">medSurv</span>, tag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Before/"</span>, <span class="st">"Overall survival"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/report_table_tte.html">report_table_tte</a></span><span class="op">(</span><span class="va">weighted_cox</span>, <span class="va">medSurv_adj</span>, tag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"After/"</span>, <span class="st">"Overall survival"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;                   Matching treatment     N n.events(%)     median[95% CI]</span></span>
<span><span class="co">#&gt; 2  Before/Overall survival     ARM=B 300.0   178(59.3)  83.6[ 68.8;101.1]</span></span>
<span><span class="co">#&gt; 1                              ARM=A 500.0   190(38.0) 230.9[191.1;313.2]</span></span>
<span><span class="co">#&gt; 21  After/Overall survival     ARM=B 300.0   178(59.3)  83.6[ 68.8;101.1]</span></span>
<span><span class="co">#&gt; 11                             ARM=A 199.8  66.8(33.5) 362.2[237.1;452.7]</span></span>
<span><span class="co">#&gt;         HR[95% CI] p-Value</span></span>
<span><span class="co">#&gt; 2  2.67[2.16;3.29]  &lt;0.001</span></span>
<span><span class="co">#&gt; 1                         </span></span>
<span><span class="co">#&gt; 21 3.46[2.53;4.74]  &lt;0.001</span></span>
<span><span class="co">#&gt; 11</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="report-3-bootstrap-result">Report 3: Bootstrap result<a class="anchor" aria-label="anchor" href="#report-3-bootstrap-result"></a>
</h3>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">HR_bootstraps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">ipd_centered</span>,</span>
<span>  statistic <span class="op">=</span> <span class="va">bootstrap_HR</span>,</span>
<span>  centered_colnames <span class="op">=</span> <span class="va">centered_colnames</span>,</span>
<span>  pseudo_ipd <span class="op">=</span> <span class="va">pseudo_ipd</span>,</span>
<span>  model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">TIME</span>, <span class="va">EVENT</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">~</span> <span class="va">ARM</span>,</span>
<span>  ref_treat <span class="op">=</span> <span class="st">"B"</span>,</span>
<span>  R <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Median of the bootstrap samples</span></span>
<span><span class="va">HR_median</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">HR_bootstraps</span><span class="op">$</span><span class="va">t</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bootstrap CI - Percentile CI</span></span>
<span><span class="va">boot_ci_HR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci</a></span><span class="op">(</span>boot.out <span class="op">=</span> <span class="va">HR_bootstraps</span>, index <span class="op">=</span> <span class="fl">1</span>, type <span class="op">=</span> <span class="st">"perc"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bootstrap CI - BCa CI</span></span>
<span><span class="va">boot_ci_HR_BCA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci</a></span><span class="op">(</span>boot.out <span class="op">=</span> <span class="va">HR_bootstraps</span>, index <span class="op">=</span> <span class="fl">1</span>, type <span class="op">=</span> <span class="st">"bca"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">HR_median</span></span>
<span><span class="co">#&gt; [1] 0.2858165</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">boot_ci_HR</span></span>
<span><span class="co">#&gt; BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS</span></span>
<span><span class="co">#&gt; Based on 1000 bootstrap replicates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; CALL : </span></span>
<span><span class="co">#&gt; boot.ci(boot.out = HR_bootstraps, type = "perc", index = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Intervals : </span></span>
<span><span class="co">#&gt; Level     Percentile     </span></span>
<span><span class="co">#&gt; 95%   ( 0.2236,  0.3689 )  </span></span>
<span><span class="co">#&gt; Calculations and Intervals on Original Scale</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">boot_ci_HR_BCA</span></span>
<span><span class="co">#&gt; BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS</span></span>
<span><span class="co">#&gt; Based on 1000 bootstrap replicates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; CALL : </span></span>
<span><span class="co">#&gt; boot.ci(boot.out = HR_bootstraps, type = "bca", index = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Intervals : </span></span>
<span><span class="co">#&gt; Level       BCa          </span></span>
<span><span class="co">#&gt; 95%   ( 0.2296,  0.3789 )  </span></span>
<span><span class="co">#&gt; Calculations and Intervals on Original Scale</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="report-4-diagnosis-plot">Report 4: Diagnosis Plot<a class="anchor" aria-label="anchor" href="#report-4-diagnosis-plot"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># grambsch &amp; theaneu ph test</span></span>
<span><span class="va">coxdiag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/cox.zph.html" class="external-link">cox.zph</a></span><span class="op">(</span><span class="va">unweighted_cox</span>, global <span class="op">=</span> <span class="cn">FALSE</span>, transform <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span></span>
<span><span class="va">coxdiag_adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/cox.zph.html" class="external-link">cox.zph</a></span><span class="op">(</span><span class="va">weighted_cox</span>, global <span class="op">=</span> <span class="cn">FALSE</span>, transform <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">coxdiag</span></span>
<span><span class="co">#&gt;       chisq df    p</span></span>
<span><span class="co">#&gt; ARM 0.00996  1 0.92</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, tcl <span class="op">=</span> <span class="op">-</span><span class="fl">0.15</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">coxdiag</span>, yaxt <span class="op">=</span> <span class="st">"n"</span>, main <span class="op">=</span> <span class="st">"Grambsch &amp; Terneau Plot (before matching)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">2</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="using_maicplus_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">coxdiag_adj</span></span>
<span><span class="co">#&gt;      chisq df    p</span></span>
<span><span class="co">#&gt; ARM 0.0438  1 0.83</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, tcl <span class="op">=</span> <span class="op">-</span><span class="fl">0.15</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">coxdiag_adj</span>, yaxt <span class="op">=</span> <span class="st">"n"</span>, main <span class="op">=</span> <span class="st">"Grambsch &amp; Terneau Plot (after matching)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">2</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="using_maicplus_files/figure-html/unnamed-chunk-14-2.png" width="700"></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># log-cumulative hazard plot</span></span>
<span><span class="fu"><a href="../reference/ph_diagplot_lch.html">ph_diagplot_lch</a></span><span class="op">(</span><span class="va">kmobj</span>,</span>
<span>  time_scale <span class="op">=</span> <span class="st">"month"</span>, log_time <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  endpoint_name <span class="op">=</span> <span class="st">"OS"</span>, subtitle <span class="op">=</span> <span class="st">"(Before Matching)"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="using_maicplus_files/figure-html/unnamed-chunk-14-3.png" width="700"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/ph_diagplot_lch.html">ph_diagplot_lch</a></span><span class="op">(</span><span class="va">kmobj_adj</span>,</span>
<span>  time_scale <span class="op">=</span> <span class="st">"month"</span>, log_time <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  endpoint_name <span class="op">=</span> <span class="st">"OS"</span>, subtitle <span class="op">=</span> <span class="st">"(After Matching)"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="using_maicplus_files/figure-html/unnamed-chunk-14-4.png" width="700"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># schoenfeld residual plot</span></span>
<span><span class="fu"><a href="../reference/ph_diagplot_schoenfeld.html">ph_diagplot_schoenfeld</a></span><span class="op">(</span><span class="va">unweighted_cox</span>,</span>
<span>  time_scale <span class="op">=</span> <span class="st">"month"</span>, log_time <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  endpoint_name <span class="op">=</span> <span class="st">"OS"</span>, subtitle <span class="op">=</span> <span class="st">"(Before Matching)"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="using_maicplus_files/figure-html/unnamed-chunk-14-5.png" width="700"></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/ph_diagplot_schoenfeld.html">ph_diagplot_schoenfeld</a></span><span class="op">(</span><span class="va">weighted_cox</span>,</span>
<span>  time_scale <span class="op">=</span> <span class="st">"month"</span>, log_time <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  endpoint_name <span class="op">=</span> <span class="st">"OS"</span>, subtitle <span class="op">=</span> <span class="st">"(After Matching)"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="using_maicplus_files/figure-html/unnamed-chunk-14-6.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="analysis-using-a-built-in-wrapper">Analysis using a built-in wrapper<a class="anchor" aria-label="anchor" href="#analysis-using-a-built-in-wrapper"></a>
</h3>
<p>One can do all this analysis in a wrapper</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># put in wrapper code</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="binary-outcome-analysis-todo">Binary outcome analysis (TODO)<a class="anchor" aria-label="anchor" href="#binary-outcome-analysis-todo"></a>
</h2>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate response data based on the known proportion of responders</span></span>
<span><span class="va">comparator_prop_events</span> <span class="op">&lt;-</span> <span class="fl">0.4</span></span>
<span></span>
<span><span class="co"># Calculate number with event. Use round() to ensure we end up with a whole number of people.</span></span>
<span><span class="co"># number without an event = Total N - number with event to ensure we keep the same number of patients</span></span>
<span><span class="va">n_with_event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">agd</span><span class="op">$</span><span class="va">N</span> <span class="op">*</span> <span class="va">comparator_prop_events</span>, digits <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">comparator_binary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"RESPONSE"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_with_event</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">agd</span><span class="op">$</span><span class="va">N</span> <span class="op">-</span> <span class="va">n_with_event</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">comparator_binary</span><span class="op">$</span><span class="va">ARM</span> <span class="op">&lt;-</span> <span class="st">"B"</span> <span class="co"># need to specify ARM for comparator data</span></span>
<span><span class="va">ipd_matched</span> <span class="op">&lt;-</span> <span class="va">weighted_data</span><span class="op">$</span><span class="va">data</span></span>
<span></span>
<span><span class="va">combined_data_binary</span> <span class="op">&lt;-</span> <span class="fu">merge_two_data</span><span class="op">(</span><span class="va">comparator_binary</span>, <span class="va">ipd_matched</span>, internal_response_name <span class="op">=</span> <span class="st">"RESPONSE"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">unweighted_OR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">RESPONSE</span> <span class="op">~</span> <span class="va">ARM</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">combined_data_binary</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Log odds ratio</span></span>
<span><span class="va">log_OR_CI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">unweighted_OR</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint.default</a></span><span class="op">(</span><span class="va">unweighted_OR</span>, level <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Odds ratio</span></span>
<span><span class="va">OR_CI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_OR_CI</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">OR_CI</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"OR"</span>, <span class="st">"OR_low_CI"</span>, <span class="st">"OR_upp_CI"</span><span class="op">)</span></span>
<span><span class="va">OR_CI</span></span>
<span></span>
<span><span class="co"># Fit a logistic regression model with weights to estimate the weighted OR</span></span>
<span><span class="va">weighted_OR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">RESPONSE</span> <span class="op">~</span> <span class="va">ARM</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">combined_data_binary</span>,</span>
<span>  weight <span class="op">=</span> <span class="va">weights</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Weighted log odds ratio</span></span>
<span><span class="va">log_OR_CI_wtd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">weighted_OR</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint.default</a></span><span class="op">(</span><span class="va">weighted_OR</span>, level <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Weighted odds ratio</span></span>
<span><span class="va">OR_CI_wtd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_OR_CI_wtd</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">OR_CI_wtd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"OR"</span>, <span class="st">"OR_low_CI"</span>, <span class="st">"OR_upp_CI"</span><span class="op">)</span></span>
<span><span class="va">OR_CI_wtd</span></span>
<span></span>
<span><span class="co"># Robust standard error</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"clubSandwich"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">vmod</span> <span class="op">&lt;-</span> <span class="fu">clubSandwich</span><span class="fu">::</span><span class="fu">vcovCR</span><span class="op">(</span><span class="va">weighted_OR</span>, cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">combined_data_binary</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"CR2"</span><span class="op">)</span></span>
<span>  <span class="va">coef_res</span> <span class="op">&lt;-</span> <span class="fu">clubSandwich</span><span class="fu">::</span><span class="fu">conf_int</span><span class="op">(</span><span class="va">weighted_OR</span>, <span class="va">vmod</span>, coef <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">OR_CI_robust</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">coef_res</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">beta</span>, <span class="va">CI_L</span>, <span class="va">CI_U</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">OR_CI_robust</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Estimate"</span>, <span class="st">"Lower 95% CI"</span>, <span class="st">"Upper 95% CI"</span><span class="op">)</span></span>
<span>  <span class="va">OR_CI_robust</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Using sandwich package</span></span>
<span><span class="va">V.sw</span> <span class="op">&lt;-</span> <span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html" class="external-link">vcovHC</a></span><span class="op">(</span><span class="va">weighted_OR</span><span class="op">)</span> <span class="co"># white's estimator</span></span>
<span><span class="va">SD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">V.sw</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">Estimate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">weighted_OR</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">OR_CI_robust2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Estimate</span>, <span class="va">Estimate</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">SD</span>, <span class="va">Estimate</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">SD</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">OR_CI_robust2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Estimate"</span>, <span class="st">"Lower 95% CI"</span>, <span class="st">"Upper 95% CI"</span><span class="op">)</span></span>
<span><span class="va">OR_CI_robust2</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by hta-pharma.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
