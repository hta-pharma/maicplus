---
title: "Binary unanchored analysis"
date: "`r Sys.Date()`"
output: 
  html_document: default
bibliography: references.bib
csl: biomedicine.csl
vignette: >
  %\VignetteIndexEntry{Using maicplus}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style type="text/css">

body{ /* Normal  */
      font-size: 14px;
  }
td {  /* Table  */
  font-size: 10px;
}
h1.title {
  font-size: 38px;
}
h1 { /* Header 1 */
  font-size: 28px;
  }
h2 { /* Header 2 */
    font-size: 22px;
}
h3 { /* Header 3 */
  font-size: 18px;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(6, 4),
  warning = FALSE
)
```


# Loading R packages

```{r}
setwd("C:/Users/swj88/Documents/Github/maicplus")
devtools::load_all()
# install.packages("maicplus")
# library(maicplus)
```

Additional suggested packages for this vignette:

```{r, message = FALSE}
library(dplyr) # this is used for data merging/cleaning
```

# Preprocessing and calculating weights

```{r}
adsl <- read.csv(system.file("extdata", "adsl.csv",
  package = "maicplus",
  mustWork = TRUE
))
adrs <- read.csv(system.file("extdata", "adrs.csv",
  package = "maicplus",
  mustWork = TRUE
))
adtte <- read.csv(system.file("extdata", "adtte.csv", package = "maicplus", mustWork = TRUE))

# Data containing the matching variables
adsl <- adsl %>%
  mutate(SEX_MALE = ifelse(SEX == "Male", 1, 0)) %>%
  mutate(AGE_SQUARED = AGE^2)

# Could use built-in function for dummizing variables
# adsl <- dummize_ipd(adsl, dummize_cols=c("SEX"), dummize_ref_level=c("Female"))

# Response data
adrs <- adrs %>%
  dplyr::filter(PARAM == "Response") %>%
  transmute(USUBJID, ARM, RESPONSE = AVAL, PARAM)

# Time to event data (overall survival)
adtte <- adtte %>%
  dplyr::filter(PARAMCD == "OS") %>%
  mutate(EVENT = 1 - CNSR) %>%
  transmute(USUBJID, ARM, TIME = AVAL, EVENT)

# Rename adsl as ipd
ipd <- adsl

# Through excel spreadsheet
# target_pop <- read.csv(system.file("extdata","aggregate_data_example_1.csv", package = "maicplus", mustWork = TRUE))
# agd <- process_agd(target_pop)

# Second approach by defining a data frame in R
agd <- data.frame(
  STUDY = "Lung study",
  ARM = "Total",
  N = 300,
  AGE_MEAN = 51,
  AGE_MEDIAN = 49,
  AGE_SD = 3.25,
  SEX_MALE_PROP = 147 / 300,
  ECOG0_PROP = 0.40,
  SMOKE_PROP = 58 / (300 - 5),
  N_PR_THER_MEDIAN = 2
)

ipd_centered <- center_ipd(ipd = ipd, agd = agd)

centered_colnames <- c("AGE", "AGE_SQUARED", "SEX_MALE", "ECOG0", "SMOKE", "N_PR_THER_MEDIAN")
centered_colnames <- paste0(centered_colnames, "_CENTERED")

weights_object <- estimate_weights(
  data = ipd_centered,
  centered_colnames = centered_colnames
)
```

We need to first simulate response data for the pseudo data based on the known proportion of responders. Let's say it was 0.4 for our case. We calculate number of events and use `round` function to ensure we end up with a whole number of people.

```{r}
comparator_prop_events <- 0.4
n_with_event <- round(agd$N * comparator_prop_events, digits = 0)
pseudo_ipd <- data.frame("RESPONSE" = c(rep(1, n_with_event), rep(0, agd$N - n_with_event)))
pseudo_ipd$ARM <- "B" # need to specify ARM for comparator data
pseudo_ipd$weights <- 1
```

We can then use unanchored wrapper to do the analysis.

```{r}
result <- maic_unanchored(
  weights_object,
  ipd = adrs,
  pseudo_ipd,
  trt_ipd = "A",
  trt_agd = "B",
  trt_var_ipd = "ARM",
  trt_var_agd = "ARM",
  endpoint_type = "binary",
  endpoint_name = "Binary Endpoint",
  eff_measure = c("OR", "RR", "RD", "Diff"),
  # time to event specific args
  time_scale = "months",
  km_conf_type = "log-log"
)

result$inferential
```
